--- 
    reset_minion: true
    
    language: node_js
    
    node_js:
      - 10.15.1
    # Build Environment
    build_environment: Ubuntu 16.04
    
    services:
      - postgres
    
    env:
      global:
        - secure: gye/F6PFtc51kq7hQAPsMxQNNjVB4ybj4X6oZ7IwxBf/JJ1HsI5DyVwLJwiDOKEPUVJzDFbHelweLSK1r8Jc/oaIwxBglh3SqCueE+ltws2lixB6aSACwZjhWnMioGO5vr784cRIyJ9Pi3U/ElECaqe7MmaotwsKQvoLDcj/U3o7PdOf/yZ/UMZuuRTHQNE0k+5U+5FyRyEQFQ3Lmev9WpNYPItm1gDfsqsczU366UEf4HfK72aRa5hocY0aC8HJUcnKaXqU66UBXMmRq6ZPry7gFJttJey3nMfxNj0z/OUlOXWHmw7dijd5xBTzroG9jBQEQC6O8h7jbPjg5D3meg==

    # Create directories for test and coverage reports
    before_script:
      - mkdir -p shippable/testresults
      - mkdir -p shippable/codecoverage
      - psql -c "CREATE DATABASE users_api;" -U postgres
      - psql -U postgres -d users_api -c "CREATE TABLE leaderboard ( USER_ID serial PRIMARY KEY, USERNAME VARCHAR (50) UNIQUE NOT NULL, SCORE integer NOT NULL );"
      - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 379CE192D401AB61
      - echo "deb https://dl.bintray.com/loadimpact/deb stable main" | sudo tee -a /etc/apt/sources.list
      - sudo apt-get update
      - sudo apt-get install k6
    build:  
      ci:
        - npm install
        - NODE_ENV=production PORT=3000 npm start & >> app.log
        - npm test
        - npm run perf:test