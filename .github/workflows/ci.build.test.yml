name: CI

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

env:
    NODE_ENV: production
    SENDGRID_API_KEY: off
    PORT: 3000
    ELEPHANT_URL: ${{ secrets.ELEPHANT_URL_TEST}}

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [19.x]
        steps:
            - uses: actions/checkout@v2
            
            - name: Run test on Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v2
              with:
                node-version: ${{ matrix.node-version }}
            - run: npm install            
            - run: |
                    mkdir -p testResults
                    npm start & sleep 10
                    node_modules/.bin/newman run test/COVID19_the_game_villain.postman_collection.json --env-var url=http://localhost:3000 -r cli,htmlextra --reporter-htmlextra-export testResults/htmlreport.html
                    npx cypress run
            - name: Upload test results
              uses: actions/upload-artifact@v2
              with:
                    name: Test results
                    path: testResults
    
    restassure-test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Set up JDK 11
              uses: actions/setup-java@v1
              with:
                    java-version: 11
            - name: Build with Maven
              run: |
                cd restassured-project
                mvn clean test